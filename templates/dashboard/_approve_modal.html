<!-- Approve Modal & JS (shared) -->
<div class="modal fade" id="approveModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content text-dark">
      <div class="modal-header">
        <h5 class="modal-title">Approve Payment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="approveForm">
          {% csrf_token %}
          <div class="mb-3">
            <label for="approvalReason" class="form-label">Reason or note (optional)</label>
            <textarea class="form-control" id="approvalReason" name="reason" rows="3"></textarea>
          </div>
          <input type="hidden" id="approveRegId" name="reg_id" value="">
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirmApprove">Approve</button>
      </div>
    </div>
  </div>
</div>

<script>
// CSRF helper
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Modal instance
const approveModalEl = document.getElementById('approveModal');
let approveModalInstance = null;
if (approveModalEl) approveModalInstance = new bootstrap.Modal(approveModalEl);

// Open approve modal (delegated)
document.addEventListener('click', (e) => {
    const target = e.target;
    if (target && target.matches('.open-approve-modal')) {
        const regId = target.getAttribute('data-id');
        document.getElementById('approveRegId').value = regId;
        document.getElementById('approvalReason').value = '';
        if (approveModalInstance) approveModalInstance.show();
    }
});

// Confirm approve
document.addEventListener('click', async (e) => {
    if (!e.target) return;
    if (e.target.id === 'confirmApprove') {
        const regId = document.getElementById('approveRegId').value;
        const reason = document.getElementById('approvalReason').value || '';
        const url = `{% url 'dashboard:management_approve_payment' 0 %}`.replace('/0/', `/${regId}/`);
        try {
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({ reason })
            });
            const data = await res.json();
            if (data.success) {
                const row = document.getElementById(`reg-${regId}`);
                if (row) {
                    const verifiedTd = row.querySelector('.is-verified');
                    const approvedByTd = row.querySelector('.approved-by');
                    const reasonTd = row.querySelector('.approval-reason');
                    if (verifiedTd) verifiedTd.innerHTML = '<span class="badge bg-success">Yes</span>';
                    if (approvedByTd) approvedByTd.innerText = data.verified_by || '';
                    if (reasonTd) reasonTd.innerText = (data.reason || '').slice(0,80);
                    // swap action button
                    const btn = row.querySelector('.open-approve-modal') || row.querySelector('.toggle-verify');
                    if (btn) {
                        btn.classList.remove('open-approve-modal', 'btn-success');
                        btn.classList.add('toggle-verify', 'btn-danger');
                        btn.innerText = 'Un-verify';
                        btn.setAttribute('data-id', regId);
                    }
                }
                if (approveModalInstance) approveModalInstance.hide();
            } else {
                alert(data.error || 'Error approving payment');
            }
        } catch (err) {
            alert('Network error');
        }
    }
});

// Toggle verify/un-verify (delegated)
document.addEventListener('click', async (e) => {
    const target = e.target;
    if (target && target.matches('.toggle-verify')) {
        const regId = target.getAttribute('data-id');
        target.disabled = true;
        const url = `{% url 'dashboard:management_toggle_payment' 0 %}`.replace('/0/', `/${regId}/`);
        try {
            const res = await fetch(url, { method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken') } });
            const data = await res.json();
            if (data.success) {
                const row = document.getElementById(`reg-${regId}`);
                if (row) {
                    const verifiedTd = row.querySelector('.is-verified');
                    const approvedByTd = row.querySelector('.approved-by');
                    const reasonTd = row.querySelector('.approval-reason');
                    if (data.is_verified) {
                        if (verifiedTd) verifiedTd.innerHTML = '<span class="badge bg-success">Yes</span>';
                    } else {
                        if (verifiedTd) verifiedTd.innerHTML = '<span class="badge bg-warning text-dark">No</span>';
                        if (approvedByTd) approvedByTd.innerText = '';
                        if (reasonTd) reasonTd.innerText = '';
                        // convert button back to Approve
                        target.classList.remove('toggle-verify', 'btn-danger');
                        target.classList.add('open-approve-modal', 'btn-success');
                        target.innerText = 'Approve';
                        target.setAttribute('data-id', regId);
                    }
                }
            } else {
                alert(data.error || 'Error toggling verification');
            }
        } catch (err) {
            alert('Network error');
        } finally {
            target.disabled = false;
        }
    }
});
</script>
